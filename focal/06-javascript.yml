---
- hosts: all
  gather_facts: yes
  vars:
    NODEJS_VERSION: "12"
  become: yes
  tasks:
    - name: 20_js
      blockinfile:
        path: "{{lookup('env', 'HOME')}}/.config/cfg/20_js.cfg"
        create: yes
        marker: "# {mark} Javascript ENV"
        block: |
          export NPM_PACKAGES="${HOME}/.local/npm-packages"
          PATH="${NPM_PACKAGES}/bin:${PATH}"
          export MANPATH="$NPM_PACKAGES/share/man:${MANPATH}"
    - name: 20_js ownership
      file:
        path: "{{lookup('env', 'HOME')}}/.config/cfg/20_js.cfg"
        group: "{{lookup('env', 'USER')}}"
        owner: "{{lookup('env', 'USER')}}"
    - name: npmrc remove
      file:
        path: "{{lookup('env', 'HOME')}}/.npmrc"
        state: absent
    - name: npmrc
      blockinfile:
        path: "{{lookup('env', 'HOME')}}/.npmrc"
        create: yes
        marker: ""
        block: |
          prefix=${HOME}/.local/npm-packages
    - name: npmrc ownership
      file:
        path: "{{lookup('env', 'HOME')}}/.npmrc"
        group: "{{lookup('env', 'USER')}}"
        owner: "{{lookup('env', 'USER')}}"
    - name: install gpg key
      apt_key:
        url: "https://deb.nodesource.com/gpgkey/nodesource.gpg.key"
        state: present
    - name: nodejs lts repo cleanup
      file:
        path: /etc/apt/sources.list.d/nodesource.list
        state: absent
    - name: install nodejs lts repo
      apt_repository:
        validate_certs: no
        repo: "deb [arch=amd64] https://deb.nodesource.com/node_{{NODEJS_VERSION}}.x {{ ansible_lsb.codename|lower }} main"
        state: present
        filename: nodesource
        update_cache: yes
    - name: nodejs
      apt:
        name:
        - nodejs
        state: latest
    - name: yarn
      npm:
        name: yarn@berry
        global: yes
        state: present

